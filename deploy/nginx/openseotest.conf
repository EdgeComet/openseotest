# openseotest.org - Nginx Configuration
#
# This configuration handles:
# - Debug hash extraction from URLs for logging
# - Asset serving with hash-based URLs
# - PHP-FPM integration
# - Custom log format for analytics

# Custom log format for openseotest.org
# Captures debug hash from various URL patterns for request correlation
# Format: timestamp ip "user-agent" "uri" status request_time "referer" hash=X x_hash=Y
log_format openseotest '$time_iso8601 '
                        '$remote_addr '
                        '"$http_user_agent" '
                        '"$request_uri" '
                        '$status '
                        '$request_time '
                        '"$http_referer" '
                        'hash=$ost_debug_hash '
                        'x_hash=$upstream_http_x_debug_hash';

# Map to extract debug hash from various URL patterns
# /dist/{hash}/... - Asset URLs
# /api/beacon/{hash}/... - Beacon tracking
# /lab/ajax/delay-{n}/{hash}/fetch - AJAX fetch endpoints
# /lab/ajax-chain/{n}-steps/{hash}/fetch/{step} - Chain fetch endpoints
map $request_uri $ost_debug_hash {
    default                                              "-";

    # Asset URLs: /dist/{hash}/css/site.css
    ~^/dist/([a-f0-9]{8})/                               $1;

    # Beacon URLs: /api/beacon/{hash}/{event}
    ~^/api/beacon/([a-f0-9]{8})/                         $1;

    # AJAX fetch URLs: /lab/ajax/delay-{delay}/{hash}/fetch
    ~^/lab/ajax/delay-\d+/([a-f0-9]{8})/fetch            $1;

    # AJAX chain fetch URLs: /lab/ajax-chain/{n}-steps/{hash}/fetch/{step}
    ~^/lab/ajax-chain/\d+-steps/([a-f0-9]{8})/fetch/     $1;

    # Realtime status URL: /lab/realtime/timer/{hash}/status
    ~^/lab/realtime/timer/([a-f0-9]{8})/status           $1;
}

server {
    listen 80;
    listen [::]:80;
    server_name openseotest.org www.openseotest.org;

    # Redirect HTTP to HTTPS
    return 301 https://openseotest.org$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name openseotest.org;

    # SSL configuration (paths to be updated for your server)
    ssl_certificate /etc/letsencrypt/live/openseotest.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/openseotest.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;

    # Document root
    root /var/www/openseotest/public;
    index index.php;

    # Include Cloudflare real IP configuration
    include /etc/nginx/snippets/cloudflare-ips.conf;

    # Access log with custom format
    access_log /var/log/nginx/openseotest.access.log openseotest;
    error_log /var/log/nginx/openseotest.error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Static asset serving with hash-based URLs
    # /dist/{hash}/css/... and /dist/{hash}/js/...
    # Serve directly from assets/ directory, ignoring the hash
    location ~ ^/dist/[a-f0-9]{8}/(css|js)/(.+)$ {
        alias /var/www/openseotest/assets/$1/$2;

        # Cache static assets for 1 year (hash changes on content change)
        expires 1y;
        add_header Cache-Control "public, immutable";

        # Set correct content types
        types {
            text/css css;
            application/javascript js;
        }
    }

    # Robots.txt - serve directly
    location = /robots.txt {
        try_files $uri =404;
    }

    # Sitemap - route to PHP
    location = /sitemap.xml {
        try_files $uri /index.php$is_args$args;
    }

    # PHP-FPM configuration
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

        # Pass debug hash to PHP via header (optional)
        fastcgi_param HTTP_X_OST_DEBUG_HASH $ost_debug_hash;
    }

    # Main location - try files, then route to front controller
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # Deny access to config directory
    location ^~ /config/ {
        deny all;
    }

    # Deny access to src directory (except via PHP)
    location ^~ /src/ {
        deny all;
    }

    # Deny access to tests directory
    location ^~ /tests/ {
        deny all;
    }

    # Deny access to vendor directory
    location ^~ /vendor/ {
        deny all;
    }

    # Deny access to logs directory
    location ^~ /logs/ {
        deny all;
    }
}

# Redirect www to non-www
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.openseotest.org;

    ssl_certificate /etc/letsencrypt/live/openseotest.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/openseotest.org/privkey.pem;

    return 301 https://openseotest.org$request_uri;
}
