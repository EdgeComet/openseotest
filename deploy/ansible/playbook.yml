# Ansible Playbook for deploying openseotest.org
#
# This playbook deploys the openseotest.org application to a production server.
#
# Prerequisites:
#   - Target server has PHP 8.3, nginx, and Composer installed
#   - SSL certificates are already configured (Let's Encrypt recommended)
#   - SSH access with sudo privileges
#
# Usage:
#   ansible-playbook -i inventory.yml playbook.yml
#
# Dry run (check mode):
#   ansible-playbook -i inventory.yml playbook.yml --check
#
# Verbose output:
#   ansible-playbook -i inventory.yml playbook.yml -v

---
- name: Deploy openseotest.org
  hosts: production
  become: yes
  gather_facts: yes

  vars:
    local_project_path: "{{ playbook_dir }}/../.."

  tasks:
    # ==========================================================================
    # Pre-deployment checks
    # ==========================================================================

    - name: Check PHP version
      command: php -v
      register: php_version_output
      changed_when: false
      failed_when: "'PHP 8.3' not in php_version_output.stdout"

    - name: Check Composer is installed
      command: composer --version
      register: composer_version_output
      changed_when: false

    - name: Check nginx is installed
      command: nginx -v
      register: nginx_version_output
      changed_when: false

    # ==========================================================================
    # Directory structure
    # ==========================================================================

    - name: Create application directory
      file:
        path: "{{ app_root }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: "0755"

    - name: Create logs directory
      file:
        path: "{{ app_logs }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: "0755"

    - name: Create required subdirectories
      file:
        path: "{{ app_root }}/{{ item }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: "0755"
      loop:
        - public
        - public/errors
        - src
        - config
        - assets
        - assets/css
        - assets/css/templates
        - assets/js
        - assets/js/tests
        - assets/js/tests/js-errors

    # ==========================================================================
    # Sync application files
    # ==========================================================================

    - name: Sync application files
      synchronize:
        src: "{{ local_project_path }}/"
        dest: "{{ app_root }}/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--exclude={{ item }}"
      loop: "{{ rsync_excludes }}"
      register: sync_result

    - name: Set ownership on application files
      file:
        path: "{{ app_root }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        recurse: yes

    - name: Set directory permissions
      command: find {{ app_root }} -type d -exec chmod 755 {} \;
      changed_when: false

    - name: Set file permissions
      command: find {{ app_root }} -type f -exec chmod 644 {} \;
      changed_when: false

    # ==========================================================================
    # Composer dependencies
    # ==========================================================================

    - name: Install Composer dependencies (production)
      composer:
        command: install
        working_dir: "{{ app_root }}"
        no_dev: yes
        optimize_autoloader: yes
      become_user: "{{ deploy_user }}"
      environment:
        COMPOSER_ALLOW_SUPERUSER: "1"

    # ==========================================================================
    # Environment configuration
    # ==========================================================================

    - name: Check if .env file exists
      stat:
        path: "{{ app_root }}/.env"
      register: env_file

    - name: Create .env file from example if not exists
      copy:
        src: "{{ app_root }}/.env.example"
        dest: "{{ app_root }}/.env"
        remote_src: yes
        owner: "{{ deploy_user }}"
        group: "{{ deploy_group }}"
        mode: "0640"
      when: not env_file.stat.exists

    - name: Set production environment in .env
      lineinfile:
        path: "{{ app_root }}/.env"
        regexp: "^APP_ENV="
        line: "APP_ENV=production"
      when: env_file.stat.exists or not env_file.stat.exists

    - name: Disable debug in .env
      lineinfile:
        path: "{{ app_root }}/.env"
        regexp: "^APP_DEBUG="
        line: "APP_DEBUG=false"

    # ==========================================================================
    # Nginx configuration
    # ==========================================================================

    - name: Copy Cloudflare IPs configuration
      copy:
        src: "{{ local_project_path }}/deploy/nginx/cloudflare-ips.conf"
        dest: "{{ nginx_snippets_path }}/cloudflare-ips.conf"
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Copy nginx site configuration
      copy:
        src: "{{ local_project_path }}/deploy/nginx/openseotest.conf"
        dest: "{{ nginx_conf_path }}/openseotest.conf"
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Enable nginx site
      file:
        src: "{{ nginx_conf_path }}/openseotest.conf"
        dest: "{{ nginx_enabled_path }}/openseotest.conf"
        state: link
      notify: Reload nginx

    - name: Test nginx configuration
      command: nginx -t
      changed_when: false

    # ==========================================================================
    # PHP-FPM configuration
    # ==========================================================================

    - name: Copy PHP-FPM pool configuration
      copy:
        src: "{{ local_project_path }}/deploy/php-fpm/openseotest.conf"
        dest: "/etc/php/{{ php_version }}/fpm/pool.d/openseotest.conf"
        owner: root
        group: root
        mode: "0644"
      notify: Reload PHP-FPM

    # ==========================================================================
    # Verification
    # ==========================================================================

    - name: Verify site responds
      uri:
        url: "https://{{ app_domain }}/"
        method: GET
        status_code: 200
        validate_certs: yes
      register: site_check
      retries: 3
      delay: 5
      until: site_check.status == 200
      ignore_errors: yes

    - name: Display deployment status
      debug:
        msg: |
          Deployment completed!

          Site URL: https://{{ app_domain }}/
          App Root: {{ app_root }}
          PHP Version: {{ php_version }}

          {% if site_check.status == 200 %}
          Site verification: SUCCESS
          {% else %}
          Site verification: FAILED (check logs)
          {% endif %}

  # ============================================================================
  # Handlers
  # ============================================================================

  handlers:
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded

    - name: Reload PHP-FPM
      service:
        name: "php{{ php_version }}-fpm"
        state: reloaded
